(function(d){function k(a,c){var b=1,e,d;d=a.length;e=0;for(d;e<d;e++)b*=a.charCodeAt(e)*n,b-=Math.floor(b);return c[Math.floor(b*c.length)]}function p(a,c){var b=null;this.element=a;this.$el=d(a);this.opts=d.extend({},q,c);this.gmap=null;this._marcadores={};this.init=function(){this.opts.center=new google.maps.LatLng(this.opts.center.lat,this.opts.center.lng);this.opts.streetViewControl=!1;this.opts.scaleControl=!0;this.opts.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.DROPDOWN_MENU};
var a=f._prepararContenedor(this.$el);this.gmap=b=new google.maps.Map(a,this.opts);this.$el.data("gmap",b);google.maps.event.addListener(b,"maptypeid_changed",function(){b.setZoom(b.getZoom()+1);b.setZoom(b.getZoom()-1)});f.GmapAgregarCapaBase(b,new f.CapaBaseArgenmap);f.GmapAgregarCapa(b,new f.CapaTMSArgenmap);this.gmap.setMapTypeId("Mapa IGN");return!0};this.agregarCapaKML=function(a){var b={preserveViewport:!0,map:this.$el.data("gmap")};a=d.extend(b,a);new google.maps.KmlLayer(a)};this.infoWindow=
function(){void 0===this._infoWindow&&(this._infoWindow=new google.maps.InfoWindow);return this._infoWindow};this.agregarMarcador=function(a){var b=this,c={icon:f.BASEURL+"img/marcadores/punto.png",title:"Marcador",nombre:"Marcador_"+Math.floor(10100*Math.random())};a.icon=a.icono||void 0;a.data=a.contenido;a.position=new google.maps.LatLng(a.lat,a.lng);a.title=a.nombre;a=d.extend(c,a);a.map=b.$el.data("gmap");var h=new google.maps.Marker(a);this._marcadores[a.nombre]=h;google.maps.event.addListener(h,
"click",function(){a.contenido&&(b.infoWindow().open(b.$el.data("gmap"),h),b.infoWindow().setContent(a.contenido))})};this.quitarMarcador=function(a){void 0!==this._marcadores[a]&&(this._marcadores[a].setMap(null),delete this._marcadores[a])};this.modificarMarcador=function(a,b){if(void 0!==this._marcadores[a]){var c=this._marcadores[a];this.quitarMarcador(a);b=d.extend(c,b);b.nombre=a;this.agregarMarcador(b)}};this.geocodificar=function(a,b){d.getJSON("http://nominatim.openstreetmap.org/search?format=json&limit=5&q="+
a,function(a){a.length&&b(a);console.log(a)},this)};this.encuadrarResultadoDeGeocodificacion=function(a){var b=a.boundingbox[2],c=a.boundingbox[1];a=new L.LatLng(a.boundingbox[0],b);b=new L.LatLng(c,b);b=new L.LatLngBounds(a,b);this.Lmap.fitBounds(b)}}var m=["http://cg.aws.af.cm/tms","http://robomap-cgastrell.rhcloud.com/tms","http://sig.ign.gob.ar/tms","http://190.220.8.216/tms","http://mapaabierto.aws.af.cm/tms"],f={BASEURL:"http://www.ign.gob.ar/argenmap/argenmap.jquery/"},n=(Math.sqrt(5)-1)/2,
q={unit:"km",zoom:5,mapTypeControl:!0,center:{lat:-34,lng:-59}};Array.prototype.indexOf||(Array.prototype.indexOf=function(a,c){var b=this.length>>>0,e=Number(c)||0,e=0>e?Math.ceil(e):Math.floor(e);for(0>e&&(e+=b);e<b;e++)if(e in this&&this[e]===a)return e;return-1});f.cacheDeCliente=function(){this.MAX_TILES=150;this.cache=[];this.cacheRef={}};f.cacheDeCliente.prototype={recuperar:function(a,c,b){a=a+"-"+c+"-"+b;return-1!==this.cache.indexOf(a)?this.cacheRef[a]:!1},guardar:function(a,c,b,e){"string"!==
typeof this.baseURL&&(a=a+"-"+c+"-"+b,this.cache.push(a),this.cacheRef[a]=e,this.cache.length>this.MAX_TILES&&(e=this.cache.shift(),delete this.cacheRef[e]))}};f.CapaBaseWMS=function(a){this.gmap=this.imageMapType=null;this.name="Capa base WMS";this.tipo="wms-1.1.1";jQuery.extend(this,a);a={alt:this.name,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!0,maxZoom:17,minZoom:3,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(a)};f.CapaBaseWMS.prototype.getTileUrl=
function(a,c){var b=this.gmap.getProjection(),e=Math.pow(2,c),d=new google.maps.Point(256*a.x/e,256*(a.y+1)/e),e=new google.maps.Point(256*(a.x+1)/e,256*a.y/e),d=b.fromPointToLatLng(d),b=b.fromPointToLatLng(e),e=this.baseURL,g=this.layers,d=f.latLngAMercator(d.lat(),d.lng()),b=f.latLngAMercator(b.lat(),b.lng());return e+"LAYERS="+g+"&TRANSPARENT=FALSE&VERSION=1.1.1&SERVICE=WMS&REQUEST=GetMap&STYLES=&FORMAT=image%2Fpng&SRS=EPSG:3857&BBOX="+(d.lng+","+d.lat+","+b.lng+","+b.lat)+"&WIDTH=256&HEIGHT=256"};
f.CapaBaseTMS=function(a){this.cache=new f.cacheDeCliente;this.gmap=this.imageMapType=null;this.name="Capa base TMS";this.tipo="tms-1.0.0";jQuery.extend(this,a);a={alt:this.name,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!0,maxZoom:17,minZoom:3,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(a)};f.CapaBaseTMS.prototype.getTileUrl=function(a,c){var b=this.baseURL;if("string"!==typeof b){var b=k(a.x+""+a.y,b),e=this.cache.recuperar(a.x,
a.y,c);if(e)return e}b=b+"/"+this.layers+"/"+c+"/"+a.x+"/"+((1<<c)-a.y-1)+".png";this.cache.guardar(a.x,a.y,c,b);return b};f.CapaWMS=function(a){this.gmap=this.imageMapType=null;this.tipo="wms-1.1.1";this.alt=this.name="CAPA WMS";jQuery.extend(this,a);a={alt:this.alt,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!1,maxZoom:17,minZoom:6,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(a)};f.CapaWMS.prototype.getTileUrl=function(a,c){var b=
this.gmap.getProjection(),e=Math.pow(2,c),d=new google.maps.Point(256*a.x/e,256*(a.y+1)/e),e=new google.maps.Point(256*(a.x+1)/e,256*a.y/e),d=b.fromPointToLatLng(d),b=b.fromPointToLatLng(e),e=this.baseURL,g=this.layers,d=f.latLngAMercator(d.lat(),d.lng()),b=f.latLngAMercator(b.lat(),b.lng());return e+"VERSION=1.1.1&REQUEST=GetMap&LAYERS="+g+"&STYLES=&SRS=EPSG:3857&BBOX="+(d.lng+","+d.lat+","+b.lng+","+b.lat)+"&WIDTH=256&HEIGHT=256&FORMAT=image/png&TRANSPARENT=TRUE"};f.CapaTMS=function(a){this.cache=
new f.cacheDeCliente;this.gmap=this.imageMapType=null;this.tipo="tms-1.0.0";this.alt=this.name="CAPA TMS";jQuery.extend(this,a);a={alt:this.alt,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!1,maxZoom:17,minZoom:6,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(a)};f.CapaTMS.prototype.getTileUrl=function(a,c){var b=this.baseURL;if("string"!==typeof b){var b=k(a.x+""+a.y,b),d=this.cache.recuperar(a.x,a.y,c);if(d)return d}b=b+"/"+this.layers+
"/"+c+"/"+a.x+"/"+((1<<c)-a.y-1)+".png";this.cache.guardar(a.x,a.y,c,b);return b};f.CapaBaseArgenmap=function(){f.CapaBaseTMS.apply(this,[{name:"Mapa IGN",baseURL:m,layers:"capabaseargenmap"}])};f.CapaBaseArgenmap.prototype.getTileUrl=function(){return f.CapaBaseTMS.prototype.getTileUrl.apply(this,arguments)};f.CapaTMSArgenmap=function(){f.CapaTMS.apply(this,[{name:"IGN",baseURL:m,layers:"capabasesigign"}])};f.CapaTMSArgenmap.prototype.getTileUrl=function(a,c){return"satellite"!==this.gmap.getMapTypeId()?
!1:f.CapaTMS.prototype.getTileUrl.apply(this,arguments)};f.GmapAgregarCapaBase=function(a,c){var b;c.gmap=a;a.mapTypes.set(c.imageMapType.name,c.imageMapType);a.mapTypeControlOptions?(b=a.mapTypeControlOptions.mapTypeIds)?b.splice(0,0,c.imageMapType.name):b=[c.imageMapType.name,"satellite"]:b=[c.imageMapType.name,"satellite"];a.setOptions({mapTypeControlOptions:{mapTypeIds:b,style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}})};f.GmapAgregarCapa=function(a,c){c.gmap=a;a.overlayMapTypes.push(c.imageMapType)};
f._prepararContenedor=function(a){var c=f.BASEURL+"img/logoignsintexto-25px.png",b=d('<div class="argenmapMapCanvas" />').css({width:"100%","min-height":"200px"}),e=d('<div class="argenmapMapFooter" />').css({"font-family":"Arial","background-color":"#1C74A5","box-shadow":"0 0 11px rgb(5, 66, 100) inset","font-size":"10px","text-align":"right",height:"30px","vertical-align":"middle",color:"white","min-height":"25px","line-height":"13px",padding:"5px",margin:0,border:0}),l=d("<img />"),g=d('<a style="float:left" target="_blank" href="http://www.ign.gob.ar/argenmap/argenmap.jquery/docs"></a>').append(l);
l.attr("src",c).css({border:"0"});a.append(b);a.append(e);e.append(g);e.append('<a style="color:white;text-decoration:underline;font-weight:normal" target="_blank" href="http://www.ign.gob.ar/argenmap/argenmap.jquery/docs/#datosvectoriales">Top&oacute;nimos, datos topogr&aacute;ficos - 2013 IGN Argentina // Calles - OpenStreetMap</a>');f._maximizarCanvas(a,e,b);return b.get(0)};f._maximizarCanvas=function(a,c,b){var d=a.innerHeight()-c.outerHeight();b.height(d);a.bind("resized",function(d){d=a.innerHeight()-
c.outerHeight();b.height(d);google.maps.event.trigger(a.data().gmap,"resize")})};f.latLngAMercator=function(a,d){var b=2.003750834E7*d/180,e=Math.log(Math.tan((90+a)*Math.PI/360))/(Math.PI/180);return{lat:2.003750834E7*e/180,lng:b}};d.event.special.resized={interval:0,setup:function(){var a=this,c=d(this),b=c.width(),e=c.height();d.event.special.resized.interval=setInterval(function(){if(b!==c.width()||e!==c.height())b=c.width(),e=c.height(),jQuery.event.handle.call(a,{type:"resized"})},100)},teardown:function(){clearInterval(d.event.special.resized.interval)}};
d.fn.argenmap=function(a){var c=[];d.each(this,function(){var b=d(this).data("argenmap");b||(b=new p(this,a),d(this).data("argenmap",b),b.init())});return c.length?1===c.length?c[0]:c:this};d.fn.agregarCapaBaseWMS=function(a){return this.each(function(){if(d(this).data("argenmap")){var c=d(this).data("gmap");f.GmapAgregarCapaBase(c,new f.CapaBaseWMS({name:a.nombre,baseURL:a.url,layers:a.capas}))}})};d.fn.agregarCapaBaseTMS=function(a){return this.each(function(){if(d(this).data("argenmap")){var c=
d(this).data("gmap");f.GmapAgregarCapaBase(c,new f.CapaBaseTMS({name:a.nombre,baseURL:a.url,layers:a.capas}))}})};d.fn.agregarCapaWMS=function(a){return this.each(function(){if(d(this).data("argenmap")){var c=d(this).data("gmap");f.GmapAgregarCapa(c,new f.CapaWMS({name:a.nombre,baseURL:a.url,layers:a.capas}))}})};d.fn.agregarCapaTMS=function(a){return this.each(function(){if(d(this).data("argenmap")){var c=d(this).data("gmap");f.GmapAgregarCapaTMS(c,new f.CapaTMS({name:a.nombre,baseURL:a.url,layers:a.capas}))}})};
d.fn.agregarCapaKML=function(a){return this.each(function(){var c=d(this).data("argenmap");c&&c.agregarCapaKML(a)})};d.fn.centro=function(a,c){if(0===arguments.length){if(!this.data("argenmap"))return[];var b=this.data("gmap").getCenter();return b?[b.lat(),b.lng()]:[]}return this.each(function(){d(this).data("argenmap")&&d(this).data("gmap").setCenter(new google.maps.LatLng(a,c))})};d.fn.zoom=function(a){if(void 0===a){if(!this.data("argenmap"))return null;var c=this.data("gmap").getZoom();return c?
c:null}return this.each(function(){d(this).data("argenmap")&&d.isNumeric(a)&&d(this).data("gmap").setZoom(a)})};d.fn.capaBase=function(a){if(void 0===a){if(!this.data("argenmap"))return null;var c=this.data("gmap").mapTypeId;return c?c:null}return this.each(function(){d(this).data("argenmap")&&d(this).data("gmap").setMapTypeId(a)})};d.fn.agregarMarcador=function(a,c){var b=arguments;return this.each(function(){var c=d.extend({},a),f=d(this).data("argenmap");f&&(0===b.length?(c.lat=d(this).data("gmap").getCenter().lat(),
c.lng=d(this).data("gmap").getCenter().lng()):2===b.length&&(d.isNumeric(b[0])&&d.isNumeric(b[1]))&&(c.lat=b[0],c.lng=b[1]),c.hasOwnProperty("long")?c.lng=c["long"]:c.hasOwnProperty("lon")?c.lng=c.lon:c.hasOwnProperty("lat")&&"function"===typeof c.lat&&(c.lat=c.lat(),c.lng=c.lng()),f.agregarMarcador(c))})};d.fn.agregarMarcadores=function(a){return this.each(function(){d(this).data("argenmap")&&d.each(a,function(a,b){d(this).agregarMarcador(b)})})};d.fn.limpiarMapa=function(a){return this.each(function(){d(this).data("argenmap")&&
d(this).argenmap({accion:"limpiar"})})};d.fn.quitarMarcador=function(a){return this.each(function(c,b){if("string"===typeof a){var e=d(this).data("argenmap");e&&e.quitarMarcador(a)}})};d.fn.modificarMarcador=function(a,c){return this.each(function(b,e){if("string"===typeof a&&void 0!==c&&"object"===typeof c){var f=d(this).data("argenmap");f&&f.modificarMarcador(a,c)}})}})(jQuery);
