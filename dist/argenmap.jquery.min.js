/*!
 * argenmap.jquery v1
 * 
 * Version     : 1.5.0 (2014-01-15)
 * Licencia    : https://raw.github.com/oskosk/argenmap.jquery/master/LICENCIA
 * Web site    : http://ign.gob.ar/argenmap
 * Repositorio : http://github.com/oskosk/argenmap.jquery
 * Issues      : https://github.com/oskosk/argenmap.jquery/issues
 * Contacto    : argenmap@ign.gob.ar
 * 
 * Instituto Geografico Nacional de Argentina
 * Todos los derechos reservados.
 *
 */

!function(a){function b(a,b){var c,d,e=1;for(d=a.length,c=0,d;d>c;c++)e*=a.charCodeAt(c)*f,e-=Math.floor(e);return b[Math.floor(e*b.length)]}function c(b,c){var d=null;this.element=b,this.$el=a(b),this.opts=a.extend({},g,c),this.gmap=null,this._marcadores={},this._dragging=!1,this.init=function(){var a=this;a.opts.center=new google.maps.LatLng(a.opts.center.lat,a.opts.center.lng),a.opts.streetViewControl=!1,a.opts.scaleControl=!0,a.opts.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.DROPDOWN_MENU};var b=e._prepararContenedor(this.$el);return this.gmap=d=new google.maps.Map(b,a.opts),a.mapearEventosDelMapa(),this.$el.data("gmap",d),google.maps.event.addListener(d,"maptypeid_changed",function(){d.setZoom(d.getZoom()+1),d.setZoom(d.getZoom()-1)}),e.GmapAgregarCapaBase(d,new e.CapaBaseArgenmap),e.GmapAgregarCapa(d,new e.CapaTMSArgenmap),this.gmap.setMapTypeId("Mapa IGN"),!0},this.mapearEventosDelMapa=function(){var a=this;google.maps.event.addListener(a.gmap,"zoom_changed",function(){a.$el.trigger("zoomend",a.gmap.getZoom()),a.$el.trigger("moveend",[a.gmap.getZoom(),a.$el.centro()])}),google.maps.event.addListener(a.gmap,"dragstart",function(){a._dragging=!0}),google.maps.event.addListener(a.gmap,"dragend",function(){a._dragging=!1,a.$el.trigger("moveend",[a.gmap.getZoom(),a.$el.centro()])}),google.maps.event.addListener(a.gmap,"center_changed",function(){a._dragging||a.$el.trigger("moveend",[a.gmap.getZoom(),a.$el.centro()])})},this.agregarCapaKML=function(b){var c=this,d={preserveViewport:!0,map:c.$el.data("gmap")};b=a.extend(d,b);new google.maps.KmlLayer(b)},this.infoWindow=function(){return void 0===this._infoWindow&&(this._infoWindow=new google.maps.InfoWindow),this._infoWindow},this.agregarMarcador=function(b){var c=this,d={lat:c.gmap.getCenter().lat(),lng:c.gmap.getCenter().lng(),icono:e.BASEURL+"img/marcadores/punto.png",nombre:"Marcador_"+Math.floor(10100*Math.random()),contenido:void 0};b=a.extend({},d,b),b.hasOwnProperty("long")?b.lng=b["long"]:b.hasOwnProperty("lon")?b.lng=b.lon:b.hasOwnProperty("lat")&&"function"==typeof b.lat&&(b.lat=b.lat(),b.lng=b.lng());var f={};f.icon=b.icono,f.data=b.contenido,f.position=new google.maps.LatLng(b.lat,b.lng),f.title=b.nombre,f.map=c.gmap;var g=new google.maps.Marker(f);this._marcadores[b.nombre]=g,google.maps.event.addListener(g,"click",function(){b.contenido&&(c.infoWindow().open(c.$el.data("gmap"),g),c.infoWindow().setContent(b.contenido))})},this.quitarMarcador=function(a){void 0!==this._marcadores[a]&&(this._marcadores[a].setMap(null),delete this._marcadores[a])},this.modificarMarcador=function(b,c){if(void 0!==this._marcadores[b]){var d=this._marcadores[b];this.quitarMarcador(b),c=a.extend(d,c),c.nombre=b,this.agregarMarcador(c)}},this.encuadrar=function(a){var b=this,c=a.sur,d=a.oeste,e=a.norte,f=(a.este,new google.maps.LatLng(c,d)),g=new google.maps.LatLng(e,d),h=new google.maps.LatLngBounds(f,g);b.gmap.fitBounds(h)},this.geocodificar=function(b,c){var d=this;a.getJSON("http://nominatim.openstreetmap.org/search?format=json&limit=5&q="+b,function(a){a.length&&c(a),console.log(a)},d)}}var d=["http://cg.aws.af.cm/tms","http://190.220.8.216/tms","http://mapaabierto.aws.af.cm/tms","http://igntiles1.ap01.aws.af.cm/tms"],e={};e.BASEURL="http://www.ign.gob.ar/argenmap/argenmap.jquery/";var f=(Math.sqrt(5)-1)/2,g={unit:"km",zoom:5,mapTypeControl:!0,center:{lat:-34,lng:-59}};Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=this.length>>>0,c=Number(arguments[1])||0;for(c=0>c?Math.ceil(c):Math.floor(c),0>c&&(c+=b);b>c;c++)if(c in this&&this[c]===a)return c;return-1}),e.cacheDeCliente=function(){this.MAX_TILES=150,this.cache=[],this.cacheRef={}},e.cacheDeCliente.prototype={recuperar:function(a,b,c){var d=a+"-"+b+"-"+c;return-1!==this.cache.indexOf(d)?this.cacheRef[d]:!1},guardar:function(a,b,c,d){if("string"!=typeof this.baseURL){var e=a+"-"+b+"-"+c;this.cache.push(e),this.cacheRef[e]=d;var f;this.cache.length>this.MAX_TILES&&(f=this.cache.shift(),delete this.cacheRef[f])}}},e.CapaBaseWMS=function(a){this.imageMapType=null,this.gmap=null,this.name="Capa base WMS",this.tipo="wms-1.1.1",jQuery.extend(this,a);var b={alt:this.name,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!0,maxZoom:17,minZoom:3,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(b)},e.CapaBaseWMS.prototype.getTileUrl=function(a,b){var c=this.gmap.getProjection(),d=Math.pow(2,b),f=new google.maps.Point(256*a.x/d,256*(a.y+1)/d),g=new google.maps.Point(256*(a.x+1)/d,256*a.y/d),h=c.fromPointToLatLng(f),i=c.fromPointToLatLng(g),j=this.baseURL,k="1.1.1",l="GetMap",m="image%2Fpng",n=this.layers;h=e.latLngAMercator(h.lat(),h.lng()),i=e.latLngAMercator(i.lat(),i.lng());var o="EPSG:3857",p=h.lng+","+h.lat+","+i.lng+","+i.lat,q="WMS",r="256",s="256",t="",u=j+"LAYERS="+n+"&TRANSPARENT=FALSE&VERSION="+k+"&SERVICE="+q+"&REQUEST="+l+"&STYLES="+t+"&FORMAT="+m+"&SRS="+o+"&BBOX="+p+"&WIDTH="+r+"&HEIGHT="+s;return u},e.CapaBaseTMS=function(a){this.cache=new e.cacheDeCliente,this.imageMapType=null,this.gmap=null,this.name="Capa base TMS",this.tipo="tms-1.0.0",jQuery.extend(this,a);var b={alt:this.name,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!0,maxZoom:17,minZoom:3,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(b)},e.CapaBaseTMS.prototype.getTileUrl=function(a,c){var d=this.baseURL;if("string"!=typeof d){d=b(a.x+""+a.y,d);var e=this.cache.recuperar(a.x,a.y,c);if(e)return e}var f=this.layers,g=(1<<c)-a.y-1,h=d+"/"+f+"/"+c+"/"+a.x+"/"+g+".png";return this.cache.guardar(a.x,a.y,c,h),h},e.CapaWMS=function(a){this.imageMapType=null,this.gmap=null,this.tipo="wms-1.1.1",this.name="CAPA WMS",this.alt="CAPA WMS",jQuery.extend(this,a);var b={alt:this.alt,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!1,maxZoom:17,minZoom:6,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(b)},e.CapaWMS.prototype.getTileUrl=function(a,b){var c=this.gmap.getProjection(),d=Math.pow(2,b),f=new google.maps.Point(256*a.x/d,256*(a.y+1)/d),g=new google.maps.Point(256*(a.x+1)/d,256*a.y/d),h=c.fromPointToLatLng(f),i=c.fromPointToLatLng(g),j=this.baseURL,k="1.1.1",l="GetMap",m="image/png",n=this.layers;h=e.latLngAMercator(h.lat(),h.lng()),i=e.latLngAMercator(i.lat(),i.lng());var o="EPSG:3857",p=h.lng+","+h.lat+","+i.lng+","+i.lat,q="256",r="256",s="",t=j+"VERSION="+k+"&SERVICE=WMS&REQUEST="+l+"&LAYERS="+n+"&STYLES="+s+"&SRS="+o+"&BBOX="+p+"&WIDTH="+q+"&HEIGHT="+r+"&FORMAT="+m+"&TRANSPARENT=TRUE";return t},e.CapaTMS=function(a){this.cache=new e.cacheDeCliente,this.imageMapType=null,this.gmap=null,this.tipo="tms-1.0.0",this.name="CAPA TMS",this.alt="CAPA TMS",jQuery.extend(this,a);var b={alt:this.alt,getTileUrl:jQuery.proxy(this.getTileUrl,this),isPng:!1,maxZoom:17,minZoom:6,name:this.name,tileSize:new google.maps.Size(256,256)};this.imageMapType=new google.maps.ImageMapType(b)},e.CapaTMS.prototype.getTileUrl=function(a,c){var d=this.baseURL;if("string"!=typeof d){d=b(a.x+""+a.y,d);var e=this.cache.recuperar(a.x,a.y,c);if(e)return e}var f=this.layers,g=(1<<c)-a.y-1,h=d+"/"+f+"/"+c+"/"+a.x+"/"+g+".png";return this.cache.guardar(a.x,a.y,c,h),h},e.CapaBaseArgenmap=function(){var a={name:"Mapa IGN",baseURL:d,layers:"capabaseargenmap"};e.CapaBaseTMS.apply(this,[a])},e.CapaBaseArgenmap.prototype.getTileUrl=function(){return e.CapaBaseTMS.prototype.getTileUrl.apply(this,arguments)},e.CapaTMSArgenmap=function(){var a={name:"IGN",baseURL:d,layers:"capabasesigign"};e.CapaTMS.apply(this,[a])},e.CapaTMSArgenmap.prototype.getTileUrl=function(){return"satellite"!==this.gmap.getMapTypeId()?!1:e.CapaTMS.prototype.getTileUrl.apply(this,arguments)},e.GmapAgregarCapaBase=function(a,b){var c;b.gmap=a,a.mapTypes.set(b.imageMapType.name,b.imageMapType),a.mapTypeControlOptions?(c=a.mapTypeControlOptions.mapTypeIds,c?c.splice(0,0,b.imageMapType.name):c=[b.imageMapType.name,"satellite"]):c=[b.imageMapType.name,"satellite"],a.setOptions({mapTypeControlOptions:{mapTypeIds:c,style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}})},e.GmapAgregarCapa=function(a,b){b.gmap=a,a.overlayMapTypes.push(b.imageMapType)},e._prepararContenedor=function(b){var c=e.BASEURL+"img/logoignsintexto-25px.png",d=a('<div class="argenmapMapCanvas" />').css({width:"100%","min-height":"200px"}),f=a('<div class="argenmapMapFooter" />').css({"font-family":"Arial","background-color":"#1C74A5","box-shadow":"0 0 11px rgb(5, 66, 100) inset","font-size":"10px","text-align":"right",height:"20px","vertical-align":"middle",color:"white","min-height":"15px","line-height":"15px",padding:"5px 5px",margin:0,border:0}),g=a("<img />").css({height:"20px"}),h=a('<a style="float:left" target="_blank" href="http://www.ign.gob.ar/argenmap/argenmap.jquery/docs"></a>').append(g),i=b;return g.attr("src",c).css({border:"0"}),i.append(d),i.append(f),f.append(h),f.append('<a style="color:white;text-decoration:underline;font-weight:normal" target="_blank" href="http://www.ign.gob.ar/argenmap/argenmap.jquery/docs/#datosvectoriales">Top&oacute;nimos, datos topogr&aacute;ficos - IGN Argentina // Calles - OpenStreetMap</a>'),e._maximizarCanvas(i,f,d),d.get(0)},e._maximizarCanvas=function(a,b,c){var d=a.innerHeight()-b.outerHeight();c.height(d),a.bind("resized",function(){var d=a.innerHeight()-b.outerHeight();c.height(d),google.maps.event.trigger(a.data().gmap,"resize")})},e.latLngAMercator=function(a,b){var c=20037508.34*b/180,d=Math.log(Math.tan((90+a)*Math.PI/360))/(Math.PI/180);return d=20037508.34*d/180,{lat:d,lng:c}},a.event.special.resized={interval:0,setup:function(){var b=this,c=a(this),d=c.width(),e=c.height();a.event.special.resized.interval=setInterval(function(){(d!==c.width()||e!==c.height())&&(d=c.width(),e=c.height(),jQuery.event.handle.call(b,{type:"resized"}))},100)},teardown:function(){clearInterval(a.event.special.resized.interval)}},a.fn.argenmap=function(b){var d=[];return a.each(this,function(){var d=a(this).data("argenmap");d||(d=new c(this,b),a(this).data("argenmap",d),d.init())}),d.length?1===d.length?d[0]:d:this},a.fn.agregarCapaBaseWMS=function(b){return this.each(function(){var c=a(this).data("argenmap");if(c){var d=a(this).data("gmap");e.GmapAgregarCapaBase(d,new e.CapaBaseWMS({name:b.nombre,baseURL:b.url,layers:b.capas}))}})},a.fn.agregarCapaBaseTMS=function(b){return this.each(function(){var c=a(this).data("argenmap");if(c){var d=a(this).data("gmap");e.GmapAgregarCapaBase(d,new e.CapaBaseTMS({name:b.nombre,baseURL:b.url,layers:b.capas}))}})},a.fn.agregarCapaWMS=function(b){return this.each(function(){var c=a(this).data("argenmap");if(c){var d=a(this).data("gmap");e.GmapAgregarCapa(d,new e.CapaWMS({name:b.nombre,baseURL:b.url,layers:b.capas}))}})},a.fn.agregarCapaTMS=function(b){return this.each(function(){var c=a(this).data("argenmap");if(c){var d=a(this).data("gmap");e.GmapAgregarCapaTMS(d,new e.CapaTMS({name:b.nombre,baseURL:b.url,layers:b.capas}))}})},a.fn.agregarCapaKML=function(b){return this.each(function(){var c=a(this).data("argenmap");c&&c.agregarCapaKML(b)})},a.fn.centro=function(b,c){if(0===arguments.length){if(!this.data("argenmap"))return[];var d=this.data("gmap").getCenter();return d?[d.lat(),d.lng()]:[]}return this.each(function(){var d=a(this).data("argenmap");d&&a(this).data("gmap").setCenter(new google.maps.LatLng(b,c))})},a.fn.zoom=function(b){if(void 0===b){if(!this.data("argenmap"))return null;var c=this.data("gmap").getZoom();return c?c:null}return this.each(function(){var c=a(this).data("argenmap");c&&a.isNumeric(b)&&a(this).data("gmap").setZoom(b)})},a.fn.capaBase=function(b){if(void 0===b){if(!this.data("argenmap"))return null;var c=this.data("gmap").mapTypeId;return c?c:null}return this.each(function(){var c=a(this).data("argenmap");c&&a(this).data("gmap").setMapTypeId(b)})},a.fn.agregarMarcador=function(b){return this.each(function(){var c=a(this).data("argenmap");c&&c.agregarMarcador(b)})},a.fn.agregarMarcadores=function(b){return this.each(function(){var c=this,d=a(this).data("argenmap");d&&a(b).each(function(b,d){a(c).agregarMarcador(d)})})},a.fn.limpiarMapa=function(){return this.each(function(){var b=a(this).data("argenmap");b&&a(this).argenmap({accion:"limpiar"})})},a.fn.quitarMarcador=function(b){var c=b;return this.each(function(){if("string"==typeof c){var b=a(this).data("argenmap");b&&b.quitarMarcador(c)}})},a.fn.modificarMarcador=function(b,c){var d=b,e=c;return this.each(function(){if("string"==typeof d&&void 0!==e&&"object"==typeof e){var b=a(this).data("argenmap");b&&b.modificarMarcador(d,e)}})},a.fn.encuadrar=function(b){return this.each(function(){a(this).data("argenmap");a(this).data("argenmap").encuadrar(b)})}}(jQuery);